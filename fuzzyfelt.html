<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
	<head>
		<meta http-equiv="Content-type" content="text/html;charset=UTF-8">
		<title>Jakes Fuzzy Felt</title>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	</head>
	<body>

	<div>
		<h1>Info Window</h1>
		<canvas id="canvas_info" width=500 height=30" />
	</div>

	<div>
		<h1>Short Term Tasks</h1>
		<canvas id="canvas_short" width=1300 height=2800" />
	</div>

	<div>
		<h1>Medium Term Tasks</h1>
		<canvas id="canvas_medium" width=3500 height=2800" />
	</div>

	<div>
		<h1>Long Term Tasks</h1>
		<canvas id="canvas_long" width=9300 height=2800" />
	</div>

<script type="text/javascript">

Object.getPrototypeOf(document.createElement('canvas').getContext('2d')).fillRectR = function(x,y,w,h,r)
{
	if (typeof r === "undefined")
	{
		r = 5;
	}
	this.beginPath();
	this.moveTo(x + r, y);
	this.lineTo(x + w - r, y);
	this.quadraticCurveTo(x + w, y, x + w, y + r);
	this.lineTo(x + w, y + h - r);
	this.quadraticCurveTo(x + w, y + h, x + w - r, y + h);
	this.lineTo(x + r, y + h);
	this.quadraticCurveTo(x, y + h, x, y + h - r);
	this.lineTo(x, y + r);
	this.quadraticCurveTo(x, y, x + r, y);
	this.closePath();
	this.fill();
}

Object.getPrototypeOf(document.createElement('canvas').getContext('2d')).strokeRectR = function(x,y,w,h,r)
{
	if (typeof r === "undefined")
	{
		r = 5;
	}
	this.beginPath();
	this.moveTo(x + r, y);
	this.lineTo(x + w - r, y);
	this.quadraticCurveTo(x + w, y, x + w, y + r);
	this.lineTo(x + w, y + h - r);
	this.quadraticCurveTo(x + w, y + h, x + w - r, y + h);
	this.lineTo(x + r, y + h);
	this.quadraticCurveTo(x, y + h, x, y + h - r);
	this.lineTo(x, y + r);
	this.quadraticCurveTo(x, y, x + r, y);
	this.closePath();
	this.stroke();
}
</script>
<script type="text/javascript">

const HIGH_PRIORITY = 0;
const MEDIUM_PRIORITY = 1;
const LOW_PRIORITY = 2;
const HIGH_RISK = 3;
const MEDIUM_RISK = 4;
const LOW_RISK = 5;
const TASK_UNDEFINED = 6;
const TASK_DONE = 7;
const HOLIDAY = 8;

var boxColours = [
	"#DD1111", // HIGH_PRIORITY = 0;
	"#FFCC00", // MEDIUM_PRIORITY = 1;
	"#22CC00", // LOW_PRIORITY = 2;
	"#DD1111", // HIGH_RISK = 3;
	"#FFCC00", // MEDIUM_RISK = 4;
	"#22CC00", // LOW_RISK = 5;
	"#3366FF", // TASK_UNDEFINED = 6;
	"#707070", // TASK_DONE = 7;
	"#DD11DD", // HOLIDAY = 8;
];

var monthNames = [
	"Janurary",
	"February",
	"March",
	"April",
	"May",
	"June",
	"July",
	"August",
	"September",
	"October",
	"November",
	"December",
	];

function TaskItem(owner, title, duration, taskStatus, id)
{
	this.m_owner = owner;
	this.m_title = title;
	this.m_duration = duration;
	this.m_taskStatus = taskStatus;
	if (typeof(id) === "undefined")
	{
		this.m_id = null;
	}
	else
	{
		this.m_id = id;
	}
	this.m_startDate = null;
	this.m_endDate = null;
	this.m_parentID = null;
}

function FuzzyFeltElement(text, x, y, w, h, boxColour)
{
	this.m_text = text
	this.m_x = x
	this.m_y = y
	this.m_w = w
	this.m_h = h
	this.m_boxColour = boxColour
}

function FuzzyViewData(cellWidth, cellHeight, nameX, weekX, weekY)
{
	this.m_cellWidth = cellWidth;
	this.m_cellHeight = cellHeight;
	this.m_nameX = nameX;
	this.m_weekX = weekX;
	this.m_weekY = weekY;
}

function addDates(startDate, deltaDays)
{
	var dateBits = startDate.split("/");
	var weekDay = parseInt(dateBits[0]);
	var weekMonth = parseInt(dateBits[1])-1;
	var weekYear = parseInt(dateBits[2]);
	weekDay += deltaDays;
	var date = new Date(weekYear, weekMonth, weekDay);
	var endDate = date.getDate()+"/"+(date.getMonth()+1)+"/"+date.getFullYear();
	return endDate;
}

function makeSortedTasks(tasks, startDate)
{
	var sortedTasks = [];
	var dateBits = startDate.split("/");
	var weekDay = parseInt(dateBits[0]);
	var weekMonth = parseInt(dateBits[1]);
	var weekYear = parseInt(dateBits[2]);
	var planStartDate = new Date(weekYear, weekMonth-1, weekDay);

	var ownerCurrentEnds = new Object();
	for (var i = 0; i < tasks.length; i++)
	{
		var task = tasks[i];
		var owner = task.m_owner;
		var duration = task.m_duration;

		if (typeof(ownerCurrentEnds[owner]) == "undefined")
		{
			ownerCurrentEnds[owner] = planStartDate;
		}
		var startDate = ownerCurrentEnds[owner];

		var startDateDay = startDate.getDate();
		var endDateDay = startDateDay + 7 * duration;
		var endDate = new Date(startDate.getFullYear(), startDate.getMonth(), endDateDay);
		ownerCurrentEnds[owner] = endDate;

		task.m_startDate = startDate;
		task.m_endDate = endDate;
		sortedTasks.push(task);
	}
	return sortedTasks;
}

function getLines(ctx,phrase,maxPxLength)
{
	//break the text area text into lines based on "box" width
	var wa = phrase.split(" ");
	var phraseArray = [];
	var lastPhrase = "";
	var l = maxPxLength;
	var measure = 0;
	for (var i = 0;i < wa.length; i++)
	{
		var w= wa[i];
		measure = ctx.measureText(lastPhrase+w).width;
		if (measure < l)
		{
			lastPhrase += (" "+w);
		}
		else
		{
			phraseArray.push(lastPhrase);
			lastPhrase = w;
		}
		if (i === wa.length-1)
		{
			phraseArray.push(lastPhrase);
			break;
		}
	}
	return phraseArray;
}

function drawColumnLine(ctx, x, y, h)
{
	ctx.strokeStyle = 'rgba(0,0,0,1.0)';
	ctx.lineWidth = 4.0
	ctx.beginPath();
	ctx.moveTo(x, y);
	ctx.lineTo(x, y+h);
	ctx.closePath();
	ctx.stroke();
}

function drawRowLine(ctx, x, y, w)
{
	ctx.strokeStyle = 'rgba(0,0,0,1.0)';
	ctx.lineWidth = 4.0
	ctx.beginPath();
	ctx.moveTo(x, y);
	ctx.lineTo(x+w, y);
	ctx.closePath();
	ctx.stroke();
}

function drawGrid(ctx, cellWidth, cellHeight, numRows, numCols, nameX, weekX)
{
	var w = cellWidth*numCols + weekX;
	var h = cellHeight*numRows;

	// Draw the column lines
	var x0 = 0;
	var y0 = 0;
	drawColumnLine(ctx, x0, y0, h);
	x0 = nameX;
	drawColumnLine(ctx, x0, y0, h);
	x0 = weekX;
	for (var i = 0; i < numCols; i++)
	{
		drawColumnLine(ctx, x0, y0, h);
		x0 += cellWidth;
	}
	drawColumnLine(ctx, x0, y0, h);

	// Draw the row lines
	x0 = 0;
	y0 = 0;
	drawRowLine(ctx, x0, cellHeight/2, w);
	for (var i = 0; i < numRows; i++)
	{
		drawRowLine(ctx, x0, y0, w);
		y0 += cellHeight;
	}
	drawRowLine(ctx, x0, y0, w);
}

function drawLegendShort(ctx, legendX, legendY, legendWidth, legendHeight)
{
	var x = legendX;
	var w = legendWidth - 10;
	var h = legendHeight -10;

	x += (10/2);
	y = legendY;
	y += (10/2);
	drawFuzzyFeltElement(ctx, "High Risk +100%", x, y, w, h, boxColours[HIGH_RISK]);
	y += legendHeight;
	drawFuzzyFeltElement(ctx, "Medium Risk +50%", x, y, w, h, boxColours[MEDIUM_RISK]);
	y += legendHeight;
	drawFuzzyFeltElement(ctx, "Low Risk +0%", x, y, w, h, boxColours[LOW_RISK]);
	y += legendHeight;
	drawFuzzyFeltElement(ctx, "Task Details Unknown", x, y, w, h, boxColours[TASK_UNDEFINED]);
	y += legendHeight;
	drawFuzzyFeltElement(ctx, "Task Completed", x, y, w, h, boxColours[TASK_DONE]);
	y += legendHeight;
}

function drawLegendFuture(ctx, legendX, legendY, legendWidth, legendHeight)
{
	var x = legendX;
	var w = legendWidth - 10;
	var h = legendHeight -10;

	x += (10/2);
	y = legendY;
	y += (10/2);
	drawFuzzyFeltElement(ctx, "High Priority", x, y, w, h, boxColours[HIGH_PRIORITY]);
	y += legendHeight;
	drawFuzzyFeltElement(ctx, "Medium Priority", x, y, w, h, boxColours[MEDIUM_PRIORITY]);
	y += legendHeight;
	drawFuzzyFeltElement(ctx, "Low Priority", x, y, w, h, boxColours[LOW_PRIORITY]);
	y += legendHeight;
	drawFuzzyFeltElement(ctx, "Task Details Unknown", x, y, w, h, boxColours[TASK_UNDEFINED]);
	y += legendHeight;
}

function drawCellText(ctx, text, x0, y0, w, h, bgColour)
{
	ctx.shadowOffsetX = 0;
	ctx.shadowOffsetY = 0;
	ctx.shadowBlur = 0;
	ctx.fillStyle = bgColour;
	ctx.lineWidth = 0.0;
	ctx.fillRect(x0, y0, w, h);

	var xc = x0 + w/2;
	var yc = y0 + h/2;
	ctx.shadowOffsetX = 0;
	ctx.shadowOffsetY = 0;
	ctx.shadowBlur = 0;
	ctx.textAlign = 'center';
	ctx.textBaseline = 'middle';
	ctx.strokeStyle = 'rgba(0,0,0,1.0)';
	ctx.lineWidth  = 4.0;
	ctx.fillStyle = '#000';
	ctx.fillText(text, xc, yc);
}

function drawTitle(ctx, title, n, titleX, titleY, titleWidth, titleHeight, bgColour)
{
	var x0 = titleX + n * titleWidth;
	var y0 = titleY;
	drawCellText(ctx, title, x0, y0, titleWidth, titleHeight, bgColour);
}

function drawName(ctx, name, n, nameX, nameY, nameWidth, nameHeight, bgColour)
{
	var x0 = nameX;
	var y0 = nameY + n * nameHeight;
	drawCellText(ctx, name, x0, y0, nameWidth, nameHeight, bgColour);
}

function drawFuzzyFeltElement(ctx, text, x, y, w, h, boxColour)
{
	var fuzzyFeltElement = new FuzzyFeltElement(text, x, y, w, h, boxColour);
	internalDrawFuzzyFeltElement(ctx, fuzzyFeltElement)
}

function internalDrawFuzzyFeltElement(ctx, fuzzyFeltElement)
{
	const text = fuzzyFeltElement.m_text;
	const x = fuzzyFeltElement.m_x;
	const y = fuzzyFeltElement.m_y;
	const w = fuzzyFeltElement.m_w;
	const h = fuzzyFeltElement.m_h;
	const boxColour = fuzzyFeltElement.m_boxColour;

	ctx.shadowOffsetX = 0;
	ctx.shadowOffsetY = 0;
	ctx.shadowBlur    = 0;
	ctx.shadowColor   = 'rgba(0, 0, 0, 0.0)';
	ctx.fillStyle = boxColour;
	ctx.strokeStyle = 'rgba(0,0,0,1.0)';
	ctx.fillRectR(x, y, w, h, 20);
	ctx.lineWidth = 4.0;
	ctx.strokeRectR(x, y, w, h, 20);

	ctx.shadowOffsetX = 0;
	ctx.shadowOffsetY = 0;
	ctx.shadowBlur    = 0;
	ctx.shadowColor   = 'rgba(150, 150, 150, 0.5)';
	ctx.fillStyle    = '#000';
	ctx.textAlign = 'center';
	ctx.textBaseline = 'middle';
	pxHeight = 18;
	linesArray = getLines(ctx, text, w-15);
	numLines = linesArray.length;
	textx = x+w/2;
	texty = y+h/2-(((numLines-1)/2)*pxHeight);
	for (var i=0; i < numLines; i++)
	{
		line = linesArray[i];
		ctx.fillText(line, textx, texty);
		texty += pxHeight;
	}
}

function drawFuzzyFelt(canvas, fuzzyData, names, tasks, shortTermPlan, weekDateStart, numWeeks)
{
	var ctx = canvas.getContext('2d');
	ctx.font = 'bold 18px sans-serif';

	const numPeople=names.length;

	const cellWidth=fuzzyData.m_cellWidth;
	const cellHeight=fuzzyData.m_cellHeight;
	const nameX=fuzzyData.m_nameX;
	const weekX=fuzzyData.m_weekX;
	const weekY=fuzzyData.m_weekY;

	const numCols=numWeeks;
	const numRows=numPeople+2;

	const elementHeight=cellHeight-10;

	const weekWidth=cellWidth;

	const nameY=weekY;
	const nameWidth=weekX-nameX;
	const nameHeight=cellHeight;

	const titleX=weekX;
	const titleY=0;
	const titleWidth=cellWidth;
	const titleHeight=cellHeight/2;

	const weekDateY = (weekY-titleY)/2

	const legendX = 0;
	const legendY = weekY;
	const legendWidth = nameX-legendX;
	const legendHeight = cellHeight;

	var pastelColours = [
		"#FF4848",
		"#06DCFB",
		"#79FC4E",
		"#DFE32D",
		"#DDCEFF",
		"#B4D1B6",
	];

	// Draw week titles
	var pastelColourIndex = 0;
	var lastColourText = '';
	var dateBits = weekDateStart.split("/");
	var weekDay = parseInt(dateBits[0]);
	var weekMonth = parseInt(dateBits[1]);
	var weekYear = parseInt(dateBits[2]);
	const planStartDate = new Date(weekYear, weekMonth-1, weekDay);

	for (var w = 0; w < numWeeks; w++)
	{
		weekDateString = weekDay.toString()+"/"+weekMonth.toString()+"/"+weekYear.toString();
		var fridayDate = new Date(weekYear, weekMonth-1, weekDay+5);
		var fridayMonth = fridayDate.getMonth();
		var title = monthNames[fridayMonth];
		if (title != lastColourText)
		{
			pastelColourIndex++;
			if (pastelColourIndex >= pastelColours.length)
			{
				pastelColourIndex = 0;
			}
			lastColourText = title;
		}
		var titleBGcolour = pastelColours[pastelColourIndex];
		drawTitle(ctx, title, w, titleX, titleY, titleWidth, titleHeight, titleBGcolour);

		// Draw week dates if wanted
		drawTitle(ctx, weekDateString, w, titleX, weekDateY, titleWidth, titleHeight, titleBGcolour);

		weekDay += 7
		var weekStart = new Date(weekYear, weekMonth-1, weekDay);
		weekDay = weekStart.getDate();
		weekMonth = weekStart.getMonth()+1;
		weekYear = weekStart.getFullYear();
	}

	// Draw name titles
	pastelColourIndex = 0;
	lastColourText = '';

	for (var n = 0; n < numPeople; n++)
	{
		var name = names[n];
		if (name != lastColourText)
		{
			pastelColourIndex++;
			if (pastelColourIndex >= pastelColours.length)
			{
				pastelColourIndex = 0;
			}
			lastColourText = name;
		}
		var nameBGcolour = pastelColours[pastelColourIndex];
		drawName(ctx, name, n, nameX, nameY, nameWidth, nameHeight, nameBGcolour);
	}

	drawGrid(ctx, cellWidth, cellHeight, numRows, numCols, nameX, weekX);
	if (shortTermPlan)
	{
		drawLegendShort(ctx, legendX, legendY, legendWidth, legendHeight);
	}
	else
	{
		drawLegendFuture(ctx, legendX, legendY, legendWidth, legendHeight);
	}

	fuzzyFeltElements = []

	// Draw the fuzzy felt elements
	for (var n = 0; n < numPeople; n++)
	{
		var x0 = weekX;
		var y = weekY + n*cellHeight + (10/2);
		name = names[n];
		var numWeeksForPerson = 0;
		for (var i = 0; i < tasks.length; i++)
		{
			var task = tasks[i];
			if (task.m_owner == name)
			{
				var startDate = task.m_startDate;
				var endDate = task.m_endDate;
				if (endDate > planStartDate)
				{
					var text = task.m_title;
					var duration = task.m_duration;
					var taskStatus = task.m_taskStatus;

					numWeeksForPerson += duration;
					if (numWeeksForPerson > numWeeks)
					{
						duration -= (numWeeksForPerson-numWeeks);
					}
					if (startDate < planStartDate)
					{
						var deltaTime = planStartDate - startDate;
						var weekDelta = deltaTime/(1000*60*60*24*7);
						duration -= weekDelta;
						numWeeksForPerson -= weekDelta;
					}
					if (duration <= 0)
					{
						alert("Illegal duration"+text+" "+duration);
					}

					var w = duration * weekWidth - 10;
					var h = elementHeight;
					var x = x0;
					x += (10/2);
					var boxColour = boxColours[taskStatus];

					fuzzyFeltElement = new FuzzyFeltElement(text, x, y, w, h, boxColour);
					fuzzyFeltElements.push(fuzzyFeltElement);

					x0 += duration * cellWidth;
				}
			}
			if (numWeeksForPerson >= numWeeks)
			{
				break;
			}
		}
	}

	for (var i = 0; i < fuzzyFeltElements.length; i++)
	{
		var fuzzyFeltElement = fuzzyFeltElements[i];
		internalDrawFuzzyFeltElement(ctx, fuzzyFeltElement);
	}
}

function writeMessage(canvas, message)
{
    var context = canvas.getContext('2d');
    context.clearRect(0, 0, canvas.width, canvas.height);
    context.font = '18pt Calibri';
    context.fillStyle = 'black';
    context.fillText(message, 10, 25);
}

function getMousePos(canvasName, evt)
{
	var canvas = document.getElementById(canvasName);
	// get canvas position
	var obj = canvas;
	var top = 0;
	var left = 0;
	while (obj.tagName != 'BODY') 
	{
		top += obj.offsetTop;
		left += obj.offsetLeft;
		obj = obj.offsetParent;
	}

	// return relative mouse position
	var mouseX = evt.clientX - left + window.pageXOffset;
	var mouseY = evt.clientY - top + window.pageYOffset;
	var inCanvas = false;
	if ((mouseX >= 0) && (mouseY >= 0) && (mouseX < canvas.width) && (mouseY < canvas.height))
	{
		inCanvas = true;
	}
	return mousePos = { x: mouseX, y: mouseY, in: inCanvas };
}


function mouseMove(evt)
{ 
	var inCanvas = "Short"
	var mousePos = getMousePos("canvas_short", evt);
	if (mousePos.in == false)
	{
		inCanvas = "Medium"
		mousePos = getMousePos("canvas_medium", evt);
	}
	if (mousePos.in == false)
	{
		inCanvas = "Long"
		mousePos = getMousePos("canvas_long", evt);
	}
	if (mousePos.in == true)
	{
 		var message = "Canvas:'" + inCanvas + "' Mouse position: " + mousePos.x + "," + mousePos.y;
		var infoCanvas = document.getElementById("canvas_info");
 		writeMessage(infoCanvas, message);
	}
} 

</script>

<script type="text/javascript">

window.onload = function(){
	window.addEventListener('mousemove', mouseMove, false);

	var names = [
	'P1',
	'P2',
	'P3',
	'P4',
	'P5',
	'P6',
	'P7',
	'P8',
	'P9',
	'P10',
	'P11',
	'P12',
	'P13',
	'P14',
	'P15',
	'P16',
	'P17',
	'P18',
	'P19',
	'P20',
	'P21',
];

var tasks = [
	new TaskItem("P1", "XX: make it rock", 1, TASK_DONE),
];

var shortCanvas = document.getElementById("canvas_short");
var mediumCanvas = document.getElementById("canvas_medium");
var longCanvas = document.getElementById("canvas_long");

const planStartDate = "31/10/2011"
var sortedTasks = makeSortedTasks(tasks, planStartDate)

const cellWidth = 250;
const cellHeight = 120;
const nameX = 120;
const weekX = nameX + 120;
const weekY = cellHeight;
const shortDateStart = planStartDate;
const shortNumWeeks = 4;

var fuzzyViewData = new FuzzyViewData(cellWidth, cellHeight, nameX, weekX, weekY);
drawFuzzyFelt(shortCanvas, fuzzyViewData, names, sortedTasks, true, shortDateStart, shortNumWeeks);

fuzzyViewData.m_cellWidth = 250;
const mediumDateStart = addDates(shortDateStart, shortNumWeeks*7);
const mediumNumWeeks = 13;
drawFuzzyFelt(mediumCanvas, fuzzyViewData, names, sortedTasks, false, mediumDateStart, mediumNumWeeks);

fuzzyViewData.m_cellWidth = 250;
const longDateStart = addDates(mediumDateStart, mediumNumWeeks*7);
const longNumWeeks = 52-mediumNumWeeks-shortNumWeeks;
drawFuzzyFelt(longCanvas, fuzzyViewData, names, sortedTasks, false, longDateStart, longNumWeeks);

}
</script>
</div>
</body>
</html>

