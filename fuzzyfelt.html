<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
	<head>
		<meta http-equiv="Content-type" content="text/html;charset=UTF-8">
		<title>Jakes Test Fuzzy Felt</title>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	</head>
	<body>

	<div>
		<canvas id="canvas_info" width=1200 height=30" />
	</div>

	<div>
		<h2>Short Term Tasks</h2>
		<canvas id="canvas_short" width=0 height=0" />
	</div>

	<div>
		<h2>Medium Term Tasks</h2>
		<canvas id="canvas_medium" width=0 height=0" />
	</div>

	<div>
		<h2>Long Term Tasks</h2>
		<canvas id="canvas_long" width=0 height=0" />
	</div>
<!--
-->

<script type="text/javascript">

Object.getPrototypeOf(document.createElement('canvas').getContext('2d')).fillRectR = function(x,y,w,h,r)
{
	if (typeof r === "undefined")
	{
		r = 5;
	}
	this.beginPath();
	this.moveTo(x + r, y);
	this.lineTo(x + w - r, y);
	this.quadraticCurveTo(x + w, y, x + w, y + r);
	this.lineTo(x + w, y + h - r);
	this.quadraticCurveTo(x + w, y + h, x + w - r, y + h);
	this.lineTo(x + r, y + h);
	this.quadraticCurveTo(x, y + h, x, y + h - r);
	this.lineTo(x, y + r);
	this.quadraticCurveTo(x, y, x + r, y);
	this.closePath();
	this.fill();
}

Object.getPrototypeOf(document.createElement('canvas').getContext('2d')).strokeRectR = function(x,y,w,h,r)
{
	if (typeof r === "undefined")
	{
		r = 5;
	}
	this.beginPath();
	this.moveTo(x + r, y);
	this.lineTo(x + w - r, y);
	this.quadraticCurveTo(x + w, y, x + w, y + r);
	this.lineTo(x + w, y + h - r);
	this.quadraticCurveTo(x + w, y + h, x + w - r, y + h);
	this.lineTo(x + r, y + h);
	this.quadraticCurveTo(x, y + h, x, y + h - r);
	this.lineTo(x, y + r);
	this.quadraticCurveTo(x, y, x + r, y);
	this.closePath();
	this.stroke();
}

function myLog(msg)
{
    // attempt to send a message to the console
    try
    {
        console.log(msg);
    }
    // fail gracefully if it does not exist
    catch(e){}
}

</script>
<script type="text/javascript">

const HIGH_PRIORITY = 0;
const MEDIUM_PRIORITY = 1;
const LOW_PRIORITY = 2;
const HIGH_RISK = 3;
const MEDIUM_RISK = 4;
const LOW_RISK = 5;
const TASK_UNDEFINED = 6;
const TASK_DONE = 7;
const HOLIDAY = 8;

const TYPE_NAME = "NAME";
const TYPE_MONTH = "MONTH";
const TYPE_WEEK = "WEEK";
const TYPE_LEGEND = "LEGEND";
const TYPE_FUZZY = "FUZZY";

var boxColours = [
	"#DD1111", // HIGH_PRIORITY = 0;
	"#FFCC00", // MEDIUM_PRIORITY = 1;
	"#22CC00", // LOW_PRIORITY = 2;
	"#DD1111", // HIGH_RISK = 3;
	"#FFCC00", // MEDIUM_RISK = 4;
	"#22CC00", // LOW_RISK = 5;
	"#3366FF", // TASK_UNDEFINED = 6;
	"#707070", // TASK_DONE = 7;
	"#DD11DD", // HOLIDAY = 8;
];

var monthNames = [
	"Janurary",
	"February",
	"March",
	"April",
	"May",
	"June",
	"July",
	"August",
	"September",
	"October",
	"November",
	"December",
	];

function TaskItem(owner, title, duration, taskStatus, id)
{
	this.m_owner = owner;
	this.m_title = title;
	this.m_duration = duration;
	this.m_taskStatus = taskStatus;
	if (typeof(id) === "undefined")
	{
		this.m_id = null;
	}
	else
	{
		this.m_id = id;
	}
	this.m_startDate = null;
	this.m_endDate = null;
	this.m_parentID = null;
}

function FuzzyFeltElement(text, x, y, w, h, boxColour, type)
{
	this.m_text = text;
	this.m_x = x;
	this.m_y = y;
	this.m_w = w;
	this.m_h = h;
	this.m_boxColour = boxColour;
	this.m_type = type;
	this.m_startDate = "";
	this.m_duration = 0;
}

function FuzzyViewData(cellWidth, cellHeight, nameX, weekX, weekY)
{
	this.m_cellWidth = cellWidth;
	this.m_cellHeight = cellHeight;
	this.m_nameX = nameX;
	this.m_weekX = weekX;
	this.m_weekY = weekY;
}

function getMonthIndex(monthName)
{
	for (var m = 0; m < monthNames.length; m++)
	{
		if (monthNames[m] == monthName)
		{
			return m;
		}
	}
	return -1;
}

function addDates(startDate, deltaDays)
{
	var dateBits = startDate.split("/");
	var weekDay = parseInt(dateBits[0]);
	var weekMonth = parseInt(dateBits[1]) - 1;
	var weekYear = parseInt(dateBits[2]);
	weekDay += deltaDays;
	var date = new Date(weekYear, weekMonth, weekDay);
	var endDate = date.getDate()+"/"+(date.getMonth() + 1)+"/"+date.getFullYear();
	return endDate;
}

function computeNumWeeksToShow(startDate, numWeeks)
{
	var deltaDays = numWeeks*7;
	var endDate = addDates(startDate, deltaDays);

	var dateBits = startDate.split("/");
	var weekDay = parseInt(dateBits[0]) + 5;
	var weekMonth = parseInt(dateBits[1]) - 1;
	var weekYear = parseInt(dateBits[2]);

	var dateStart = new Date(weekYear, weekMonth, weekDay);
	dateBits = endDate.split("/");
	var weekDay = parseInt(dateBits[0]) + 5;
	var weekMonth = parseInt(dateBits[1]) - 1;
	var weekYear = parseInt(dateBits[2]);
	var dateEnd = new Date(weekYear, weekMonth, weekDay);

	var startMonth = dateStart.getMonth();
	var endMonth = dateEnd.getMonth();

	return numWeeks;
}

function makeSortedTasks(tasks, startDate)
{
	var sortedTasks = [];
	var dateBits = startDate.split("/");
	var weekDay = parseInt(dateBits[0]);
	var weekMonth = parseInt(dateBits[1]);
	var weekYear = parseInt(dateBits[2]);
	var planStartDate = new Date(weekYear, weekMonth - 1, weekDay);

	var ownerCurrentEnds = new Object();
	for (var i = 0; i < tasks.length; i++)
	{
		var task = tasks[i];
		var owner = task.m_owner;
		var duration = task.m_duration;

		if (typeof(ownerCurrentEnds[owner]) == "undefined")
		{
			ownerCurrentEnds[owner] = planStartDate;
		}
		var startDate = ownerCurrentEnds[owner];

		var startDateDay = startDate.getDate();
		var endDateDay = startDateDay + 7 * duration;
		var endDate = new Date(startDate.getFullYear(), startDate.getMonth(), endDateDay);
		ownerCurrentEnds[owner] = endDate;

		task.m_startDate = startDate;
		task.m_endDate = endDate;
		sortedTasks.push(task);
	}
	return sortedTasks;
}

function getLines(ctx,phrase,maxPxLength)
{
	//break the text area text into lines based on "box" width
	var wa = phrase.split(" ");
	var phraseArray = [];
	var lastPhrase = "";
	var l = maxPxLength;
	var measure = 0;
	for (var i = 0;i < wa.length; i++)
	{
		var w= wa[i];
		measure = ctx.measureText(lastPhrase+w).width;
		if (measure < l)
		{
			lastPhrase += (" "+w);
		}
		else
		{
			phraseArray.push(lastPhrase);
			lastPhrase = w;
		}
		if (i === wa.length - 1)
		{
			phraseArray.push(lastPhrase);
			break;
		}
	}
	return phraseArray;
}

function drawColumnLine(ctx, x, y, h)
{
	ctx.strokeStyle = 'rgba(0,0,0,1.0)';
	ctx.lineWidth = 4.0
	ctx.beginPath();
	ctx.moveTo(x, y);
	ctx.lineTo(x, y+h);
	ctx.closePath();
	ctx.stroke();
}

function drawRowLine(ctx, x, y, w)
{
	ctx.strokeStyle = 'rgba(0,0,0,1.0)';
	ctx.lineWidth = 4.0
	ctx.beginPath();
	ctx.moveTo(x, y);
	ctx.lineTo(x+w, y);
	ctx.closePath();
	ctx.stroke();
}

function drawGrid(ctx, cellWidth, cellHeight, numRows, numCols, nameX, weekX)
{
	var w = cellWidth*numCols + weekX;
	var h = cellHeight*numRows -  cellHeight;

	// Draw the column lines
	var x0 = 0;
	var y0 = 0;

	y0 = 0;
	x0 = nameX;
	drawColumnLine(ctx, x0, y0, h+cellHeight/2);

	y0 = cellHeight/2;
	x0 = weekX;
	for (var i = 0; i < numCols; i++)
	{
		drawColumnLine(ctx, x0, y0, h);
		x0 += cellWidth;
	}
	y0 = 0;
	drawColumnLine(ctx, x0, y0, h+cellHeight/2);

	// Draw the row lines
	x0 = 0;
	y0 = 0;
	drawRowLine(ctx, x0, y0, w);
	drawRowLine(ctx, x0, y0+cellHeight, w);
	y0 = cellHeight/2;
	for (var i = 0; i < numRows; i++)
	{
		drawRowLine(ctx, x0, y0, w);
		y0 += cellHeight;
	}
	drawRowLine(ctx, x0, y0, w);
}

function drawLegendShort(ctx, legendX, legendY, legendWidth, legendHeight)
{
	var x = legendX;
	var w = legendWidth - 10;
	var h = legendHeight - 10;

	var legendDeltaWidth = legendWidth;
	var legendDeltaHeight = 0;

	x += (10/2);
	y = legendY;
	y += (10/2);
	drawFuzzyFeltElement(ctx, "High Risk +100%", x, y, w, h, boxColours[HIGH_RISK], TYPE_LEGEND);
	x += legendDeltaWidth;
	y += legendDeltaHeight;
	drawFuzzyFeltElement(ctx, "Medium Risk +50%", x, y, w, h, boxColours[MEDIUM_RISK], TYPE_LEGEND);
	x += legendDeltaWidth;
	y += legendDeltaHeight;
	drawFuzzyFeltElement(ctx, "Low Risk +0%", x, y, w, h, boxColours[LOW_RISK], TYPE_LEGEND);
	x += legendDeltaWidth;
	y += legendDeltaHeight;
	drawFuzzyFeltElement(ctx, "Details Unknown", x, y, w, h, boxColours[TASK_UNDEFINED], TYPE_LEGEND);
	x += legendDeltaWidth;
	y += legendDeltaHeight;
	drawFuzzyFeltElement(ctx, "Task Completed", x, y, w, h, boxColours[TASK_DONE], TYPE_LEGEND);
	x += legendDeltaWidth;
	y += legendDeltaHeight;
	drawFuzzyFeltElement(ctx, "Holiday", x, y, w, h, boxColours[HOLIDAY], TYPE_LEGEND);
	x += legendDeltaWidth;
	y += legendDeltaHeight;
}

function drawLegendFuture(ctx, legendX, legendY, legendWidth, legendHeight)
{
	var x = legendX;
	var w = legendWidth - 10;
	var h = legendHeight - 10;

	var legendDeltaWidth = legendWidth;
	var legendDeltaHeight = 0;

	x += (10/2);
	y = legendY;
	y += (10/2);
	drawFuzzyFeltElement(ctx, "High Priority", x, y, w, h, boxColours[HIGH_PRIORITY], TYPE_LEGEND);
	x += legendDeltaWidth;
	y += legendDeltaHeight;
	drawFuzzyFeltElement(ctx, "Medium Priority", x, y, w, h, boxColours[MEDIUM_PRIORITY], TYPE_LEGEND);
	x += legendDeltaWidth;
	y += legendDeltaHeight;
	drawFuzzyFeltElement(ctx, "Low Priority", x, y, w, h, boxColours[LOW_PRIORITY], TYPE_LEGEND);
	x += legendDeltaWidth;
	y += legendDeltaHeight;
	drawFuzzyFeltElement(ctx, "Details Unknown", x, y, w, h, boxColours[TASK_UNDEFINED], TYPE_LEGEND);
	x += legendDeltaWidth;
	y += legendDeltaHeight;
	drawFuzzyFeltElement(ctx, "Holiday", x, y, w, h, boxColours[HOLIDAY], TYPE_LEGEND);
	x += legendDeltaWidth;
	y += legendDeltaHeight;
}

function drawCellText(ctx, text, x0, y0, w, h, bgColour)
{
	ctx.shadowOffsetX = 0;
	ctx.shadowOffsetY = 0;
	ctx.shadowBlur = 0;
	ctx.fillStyle = bgColour;
	ctx.lineWidth = 0.0;
	ctx.fillRect(x0, y0, w, h);

	var xc = x0 + w/2;
	var yc = y0 + h/2;
	ctx.shadowOffsetX = 0;
	ctx.shadowOffsetY = 0;
	ctx.shadowBlur = 0;
	ctx.textAlign = 'center';
	ctx.textBaseline = 'middle';
	ctx.strokeStyle = 'rgba(0,0,0,1.0)';
	ctx.lineWidth  = 4.0;
	ctx.fillStyle = '#000';
	ctx.fillText(text, xc, yc);
}

function drawFuzzyFeltElement(ctx, text, x, y, w, h, boxColour, type)
{
	var fuzzyFeltElement = new FuzzyFeltElement(text, x, y, w, h, boxColour, type);
	internalDrawFuzzyFeltElement(ctx, fuzzyFeltElement)
}

function internalDrawFuzzyFeltElement(ctx, fuzzyFeltElement)
{
	const text = fuzzyFeltElement.m_text;
	const x = fuzzyFeltElement.m_x;
	const y = fuzzyFeltElement.m_y;
	const w = fuzzyFeltElement.m_w;
	const h = fuzzyFeltElement.m_h;
	const boxColour = fuzzyFeltElement.m_boxColour;

	ctx.shadowOffsetX = 0;
	ctx.shadowOffsetY = 0;
	ctx.shadowBlur    = 0;
	ctx.shadowColor   = 'rgba(0, 0, 0, 0.0)';
	ctx.fillStyle = boxColour;
	ctx.strokeStyle = 'rgba(0,0,0,1.0)';
	ctx.fillRectR(x, y, w, h, 20);
	ctx.lineWidth = 4.0;
	ctx.strokeRectR(x, y, w, h, 20);

	ctx.shadowOffsetX = 0;
	ctx.shadowOffsetY = 0;
	ctx.shadowBlur    = 0;
	ctx.shadowColor   = 'rgba(150, 150, 150, 0.5)';
	ctx.fillStyle    = '#000';
	ctx.textAlign = 'center';
	ctx.textBaseline = 'middle';
	pxHeight = 18;
	linesArray = getLines(ctx, text, w-  15);
	numLines = linesArray.length;
	textx = x+w/2;
	texty = y+h/2-(((numLines - 1)/2)*pxHeight);
	for (var i=0; i < numLines; i++)
	{
		line = linesArray[i];
		ctx.fillText(line, textx, texty);
		texty += pxHeight;
	}
}

function drawFuzzyFelt(canvasName, elements)
{
	var canvas = document.getElementById(canvasName);
	if (canvas == null)
	{
		return
	}
	var ctx = canvas.getContext('2d');
	//myLog("drawFuzzyFelt: elements:"+elements.length+" "+canvas.id);
	for (var i = 0; i < elements.length; i++)
	{
		var element = elements[i];
		internalDrawFuzzyFeltElement(ctx, element);
	}
}

function makeFuzzyFelt(canvas, fuzzyData, names, tasks, shortTermPlan, weekDateStart, numWeeks)
{
	var elements = [];
	if (numWeeks == 0)
	{
		return elements;
	}
	if (canvas == null)
	{
		return elements;
	}

	var ctx = canvas.getContext('2d');
	ctx.font = 'bold 18px sans-serif';

	const numPeople = names.length;

	const cellWidth = fuzzyData.m_cellWidth;
	const cellHeight = fuzzyData.m_cellHeight;

	const legendX = fuzzyData.m_weekX;
	const legendY = 0;
	const legendWidth = cellWidth/2-10;
	const legendHeight = cellHeight/2;

	const nameX = fuzzyData.m_nameX;
	const weekX = fuzzyData.m_weekX;

	const monthX = weekX;
	const monthY = legendY + legendHeight;
	const monthWidth = cellWidth;
	const monthHeight = cellHeight/2;

	const weekY = monthY + monthHeight;
	const weekWidth = monthWidth;
	const weekHeight = monthHeight;

	const nameY = weekY + weekHeight;
	const nameWidth = weekX - nameX;
	const nameHeight = cellHeight;

	const elementHeight = cellHeight - 10;

	const numCols = numWeeks;
	const numRows = numPeople + 1;

	var pastelColours = [
		"#FF4848",
		"#06DCFB",
		"#79FC4E",
		"#DFE32D",
		"#DDCEFF",
		"#B4D1B6",
	];

	// Draw week titles
	var pastelColourIndex = 0;
	var lastColourText = '';
	var dateBits = weekDateStart.split("/");
	var weekDay = parseInt(dateBits[0]);
	var weekMonth = parseInt(dateBits[1]);
	var weekYear = parseInt(dateBits[2]);
	const planStartDate = new Date(weekYear, weekMonth - 1, weekDay);

	for (var w = 0; w < numWeeks; w++)
	{
		weekDateString = weekDay.toString()+"/"+weekMonth.toString()+"/"+weekYear.toString();
		var fridayDate = new Date(weekYear, weekMonth - 1, weekDay + 5);
		var fridayMonth = fridayDate.getMonth();
		var month = monthNames[fridayMonth];
		if (month != lastColourText)
		{
			pastelColourIndex++;
			if (pastelColourIndex >= pastelColours.length)
			{
				pastelColourIndex = 0;
			}
			lastColourText = month;
			monthStartDate = weekDateString;
		}
		var monthBGcolour = pastelColours[pastelColourIndex];
		var x0 = monthX + w * monthWidth;
		var y0 = monthY;
		var monthElement = new FuzzyFeltElement(month, x0, y0, monthWidth, monthHeight, monthBGcolour, TYPE_MONTH);
		monthElement.m_startDate = monthStartDate;
		//TODO: compute duration correctly
		monthElement.m_duration = 4;
		elements.push(monthElement);

		// Draw week dates if wanted
		x0 = weekX + w * weekWidth;
		y0 = weekY;
		var weekElement = new FuzzyFeltElement(weekDateString, x0, y0, weekWidth, weekHeight, monthBGcolour, TYPE_WEEK);
		weekElement.m_startDate = weekDateString;
		weekElement.m_duration = 1;
		elements.push(weekElement);

		weekDay += 7
		var weekStart = new Date(weekYear, weekMonth - 1, weekDay);
		weekDay = weekStart.getDate();
		weekMonth = weekStart.getMonth() + 1;
		weekYear = weekStart.getFullYear();
	}

	// Draw name titles
	pastelColourIndex = 0;
	lastColourText = '';

	for (var n = 0; n < numPeople; n++)
	{
		var name = names[n];
		if (name != lastColourText)
		{
			pastelColourIndex++;
			if (pastelColourIndex >= pastelColours.length)
			{
				pastelColourIndex = 0;
			}
			lastColourText = name;
		}
		var nameBGcolour = pastelColours[pastelColourIndex];
		var x0 = nameX;
		var y0 = nameY + n * nameHeight;
		var nameElement = new FuzzyFeltElement(name, x0, y0, nameWidth, nameHeight, nameBGcolour, TYPE_NAME);
		elements.push(nameElement);
	}

	drawGrid(ctx, cellWidth, cellHeight, numRows+1, numCols, nameX, weekX);
	if (shortTermPlan)
	{
		drawLegendShort(ctx, legendX, legendY, legendWidth, legendHeight);
	}
	else
	{
		drawLegendFuture(ctx, legendX, legendY, legendWidth, legendHeight);
	}

	// Draw the fuzzy felt elements
	for (var n = 0; n < numPeople; n++)
	{
		var x0 = weekX;
		var y = nameY + n*cellHeight + (10/2);
		name = names[n];
		var numWeeksForPerson = 0;
		for (var i = 0; i < tasks.length; i++)
		{
			var task = tasks[i];
			if (task.m_owner == name)
			{
				var startDate = task.m_startDate;
				var endDate = task.m_endDate;
				if (endDate > planStartDate)
				{
					var text = task.m_title;
					var duration = task.m_duration;
					var taskStatus = task.m_taskStatus;

					if (startDate < planStartDate)
					{
						var deltaTime = planStartDate - startDate;
						var weekDelta = deltaTime/(1000*60*60*24*7);
						duration -= weekDelta;
						if (duration <= 0)
						{
							alert("Illegal duration3: '"+text+"' "+duration+ " taskTime:"+task.m_duration+" weekDelta:"+weekDelta);
						}
					}
					if (duration <= 0)
					{
						alert("Illegal duration1: '"+text+"' "+duration+ " taskTime:"+task.m_duration);
					}
					numWeeksForPerson += duration;
					if (numWeeksForPerson > numWeeks)
					{
						duration -= (numWeeksForPerson-numWeeks);
						if (duration <= 0)
						{
							alert("Illegal duration2: '"+text+"' "+duration+ " taskTime:"+task.m_duration);
						}
					}

					var w = duration * weekWidth - 10;
					var h = elementHeight;
					var x = x0;
					x += (10/2);
					var boxColour = boxColours[taskStatus];

					fuzzyFeltElement = new FuzzyFeltElement(text, x, y, w, h, boxColour, TYPE_FUZZY);
					elements.push(fuzzyFeltElement);

					x0 += duration * cellWidth;
				}
			}
			if (numWeeksForPerson >= numWeeks)
			{
				break;
			}
		}
	}
	return elements;
}

function writeMessage(canvas, message)
{
	var context = canvas.getContext('2d');
	context.clearRect(0, 0, canvas.width, canvas.height);
	context.font = '18pt Calibri';
	context.fillStyle = 'black';
	context.fillText(message, 10, 25);
	myLog(message);
}

function infoMessage(message)
{
	var infoCanvas = document.getElementById("canvas_info");
 	writeMessage(infoCanvas, message);
}

function getMousePos(canvas, evt)
{
	var mouseX = 0;
	var mouseY = 0;
	var inCanvas = false;
	if (canvas == null)
	{
		return mousePos = { x: mouseX, y: mouseY, in: inCanvas };
	}
	// get canvas position
	var obj = canvas;
	var top = 0;
	var left = 0;
	while (obj.tagName != 'BODY') 
	{
		top += obj.offsetTop;
		left += obj.offsetLeft;
		obj = obj.offsetParent;
	}

	// return relative mouse position
	mouseX = evt.clientX - left + window.pageXOffset;
	mouseY = evt.clientY - top + window.pageYOffset;
	inCanvas = false;
	if ((mouseX >= 0) && (mouseY >= 0) && (mouseX < canvas.width) && (mouseY < canvas.height))
	{
		inCanvas = true;
	}
	return mousePos = { x: mouseX, y: mouseY, in: inCanvas };
}

function mouseInFuzzy(elements, mousePos)
{
	var inFuzzyID = -1;
	for (var i = 0; i < elements.length; i++)
	{
		var element = elements[i];
		var x = element.m_x;
		if (mousePos.x < x)
		{
			continue;
		}
		var y = element.m_y;
		if (mousePos.y < y)
		{
			continue;
		}
		var w = element.m_w;
		var x1 = x + w;
		if (mousePos.x > x1)
		{
			continue;
		}
		var h = element.m_h;
		var y1 = y + h;
		if (mousePos.y > y1)
		{
			continue;
		}
		//myLog("mousePos:"+mousePos.x+" "+mousePos.y+" Element:"+x+" "+y+" "+x1+" "+y1);
		inFuzzyID = i;
		break;
	}
	return inFuzzyID;
}

function keyDown(evt)
{
}

function keyUp(evt)
{
	switch (evt.keyCode)
	{
		case 0x31: //'1'
		{
			infoMessage("Pressed '1'");
			var selectedNames = ["P1"];
			s_globalData["fuzzy.selectedNames"] = selectedNames;
			doFuzzyFelts();
			break;
		}
		case 0x32: //'2'
		{
			infoMessage("Pressed '2'");
			selectedNames = ["P2"];
			s_globalData["fuzzy.selectedNames"] = selectedNames;
			doFuzzyFelts();
			break;
		}
		case 70: // 'f'
		{
			infoMessage("Pressed 'f'");
			drawFullView();
			break;
		}
		case 74: // 'j'
		{
			infoMessage("Pressed 'j'");
			s_globalData["fuzzy.selectedPlanNumWeeks"] += 1;
			doFuzzyFelts();
			break;
		}
		case 76: // 'l'
		{
			infoMessage("Pressed 'l'");
			s_globalData["fuzzy.drawShort"] = false;
			s_globalData["fuzzy.drawMedium"] = false;
			s_globalData["fuzzy.drawLong"] = true;
			s_globalData["fuzzy.showSelectedDates"] = false;
			doFuzzyFelts();
			break;
		}
		case 77: // 'm'
		{
			infoMessage("Pressed 'm'");
			s_globalData["fuzzy.drawShort"] = false;
			s_globalData["fuzzy.drawMedium"] = true;
			s_globalData["fuzzy.drawLong"] = false;
			s_globalData["fuzzy.showSelectedDates"] = false;
			doFuzzyFelts();
			break;
		}
		case 78: // 'n'
		{
			infoMessage("Pressed 'n'");
			break;
		}
		case 82: // 'r'
		{
			infoMessage("Pressed 'r'");
			//s_globalData["fuzzy.selectedNames"] = [];
			//doFuzzyFelts();
			break;
		}
		case 83: // 's'
		{
			infoMessage("Pressed 's'");
			s_globalData["fuzzy.drawShort"] = true;
			s_globalData["fuzzy.drawMedium"] = false;
			s_globalData["fuzzy.drawLong"] = false;
			s_globalData["fuzzy.showSelectedDates"] = false;
			doFuzzyFelts();
			break;
		}
		case 90: // 'z'
		{
			infoMessage("Pressed 'z'");
			var selectedPlanStartDate = s_globalData["fuzzy.selectedPlanStartDate"];
			if (s_globalData["fuzzy.showSelectedDates"] == false)
			{
				selectedPlanStartDate = s_globalData["fuzzy.fullPlanStartDate"];
				s_globalData["fuzzy.showSelectedDates"] = true;
			}
			var newSelectedPlanStartDate = addDates(selectedPlanStartDate, 7);
			selectedPlanStartDate = newSelectedPlanStartDate;

			s_globalData["fuzzy.selectedPlanStartDate"] = selectedPlanStartDate;
			s_globalData["fuzzy.drawShort"] = true;
			s_globalData["fuzzy.drawMedium"] = false;
			s_globalData["fuzzy.drawLong"] = false;
			doFuzzyFelts();
			break;
		}
		default:
		{
			infoMessage(evt.keyCode);
			break;
		}
	}
}

function mouseUp(evt)
{ 
	var hitResults = doHitDetection(evt);
	var inCanvas = hitResults.InCanvas;
	var canvas_name = hitResults.CanvasName;
	var canvas = document.getElementById(canvas_name);

	var oldID = s_globalData["mouseover.id"];
	var oldCanvas = s_globalData["mouseover.canvas"];
	var oldElementsName = s_globalData["mouseover.elementsName"];
	var unhilite = true;

	var mousePos = hitResults.MousePos;
	var inFuzzyID = hitResults.InFuzzyID;
	var element = hitResults.Element;
	var elementsName  = hitResults.ElementsName;
	if (inFuzzyID >= 0)
	{
		if (element.m_type == TYPE_NAME)
		{
			var text = element.m_text;
			infoMessage("Clicked name:"+text);

			var selectedNames = [];
			var currentSelectedNames = s_globalData["fuzzy.selectedNames"];
			for (var i = 0; i < currentSelectedNames.length; i++)
			{
				var name = currentSelectedNames[i];
				if (text == name)
				{
					text = "";
					break;
				}
			}
			if (text != "")
			{
				selectedNames.push(element.m_text);
			}

			s_globalData["fuzzy.selectedNames"] = selectedNames;
			doFuzzyFelts();
		}
		if ((element.m_type == TYPE_WEEK) || (element.m_type == TYPE_MONTH))
		{
			var text = element.m_text;
			var startDate = element.m_startDate;
			var duration = element.m_duration;
			if (element.m_type == TYPE_WEEK)
			{
				infoMessage("Clicked week:"+text+" start:"+startDate+" duration:"+duration);
			}
			else
			{
				infoMessage("Clicked month:"+text+" start:"+startDate+" duration:"+duration);
			}

			if (s_globalData["fuzzy.showSelectedDates"] == false)
			{
				selectedPlanStartDate = startDate;
				s_globalData["fuzzy.showSelectedDates"] = true;
			}
			else
			{
				var oldSelectedPlanStartDate = s_globalData["fuzzy.selectedPlanStartDate"];
				var oldSelectedPlanNumWeeks = s_globalData["fuzzy.selectedPlanNumWeeks"];
				if ((selectedPlanStartDate == oldSelectedPlanStartDate) && (duration == oldSelectedPlanNumWeeks))
				{
					s_globalData["fuzzy.showSelectedDates"] = false;
					s_globalData["fuzzy.drawShort"] = true;
					s_globalData["fuzzy.drawMedium"] = true;
					s_globalData["fuzzy.drawLong"] = true;
				}
			}
			if (s_globalData["fuzzy.showSelectedDates"] == true)
			{
				s_globalData["fuzzy.selectedPlanStartDate"] = selectedPlanStartDate;
				s_globalData["fuzzy.selectedPlanNumWeeks"] = duration;
				s_globalData["fuzzy.drawShort"] = true;
				s_globalData["fuzzy.drawMedium"] = false;
				s_globalData["fuzzy.drawLong"] = false;
			}
			doFuzzyFelts();
		}
	}
}

function doHitDetection(evt)
{ 
	var inCanvas = "";
	var canvas_name = "";
	var canvas = null;
	var mousePos = { x: 0, y: 0, in: false };

	var inCanvas = "Short"
	var canvas_name = "canvas_short";
	var canvas = document.getElementById(canvas_name);
	var element = null;
	var elementsName  = "";

	var mousePos = getMousePos(canvas, evt);
	if (mousePos.in == false)
	{
		inCanvas = "Medium"
		canvas_name = "canvas_medium";
		canvas = document.getElementById(canvas_name);
		mousePos = getMousePos(canvas, evt);
	}
	if (mousePos.in == false)
	{
		inCanvas = "Long"
		canvas_name = "canvas_long";
		canvas = document.getElementById(canvas_name);
		mousePos = getMousePos(canvas, evt);
	}
	if (mousePos.in == true)
	{
 		var message = "Canvas:'" + inCanvas + "' Mouse position: " + mousePos.x + "," + mousePos.y;
 		//infoMessage(message);

		elementsName = canvas_name+".elements";
		var elements = s_globalData[elementsName];
 		//infoMessage("MouseMove: "+canvas.id+" numElements:"+elements.length);

		var inFuzzyID = mouseInFuzzy(elements, mousePos);
		if (inFuzzyID < 0)
		{
			element = null;
			elementsName  = "";
		}
		else
		{
			element = elements[inFuzzyID];
		}
	}

	return { 
						MousePos: mousePos, 
					 	InCanvas: inCanvas, 
					 	CanvasName: canvas_name, 
					 	InFuzzyID: inFuzzyID, 
					 	Element: element, 
					 	ElementsName: elementsName
				};
}

function mouseMove(evt)
{ 
	var hitResults = doHitDetection(evt);
	var inCanvas = hitResults.InCanvas;
	var canvas_name = hitResults.CanvasName;
	var canvas = document.getElementById(canvas_name);

	var oldID = s_globalData["mouseover.id"];
	var oldCanvas = s_globalData["mouseover.canvas"];
	var oldElementsName = s_globalData["mouseover.elementsName"];
	var unhilite = true;

	var mousePos = hitResults.MousePos;
	var inFuzzyID = hitResults.InFuzzyID;
	var element = hitResults.Element;
	var elementsName  = hitResults.ElementsName;
	if (inFuzzyID >= 0)
	{
		unhilite = false;
		if ((inFuzzyID != oldID) || (canvas_name != oldCanvas) || (elementsName != oldElementsName))
		{
			unhilite = true;
			var ctx = canvas.getContext('2d');
			//infoMessage("In:"+inFuzzyID+" text:"+element.m_text);
			var hilite = new FuzzyFeltElement();
			hilite.m_x = element.m_x;
			hilite.m_y = element.m_y;
			hilite.m_w = element.m_w;
			hilite.m_h = element.m_h;
			hilite.m_text = element.m_text;
			hilite.m_boxColour = element.m_boxColour;
			hilite.m_type = element.m_type;
			hilite.m_boxColour = "#FFFF66";
			internalDrawFuzzyFeltElement(ctx, hilite);

			s_globalData["mouseover.id"] = inFuzzyID;
			s_globalData["mouseover.canvas"] = canvas_name;
			s_globalData["mouseover.elementsName"] = elementsName;
		}
	}

	if (unhilite == true)
	{
		// Un hilite the old object
		if ((oldID != -1) && (oldCanvas != ""))
		{
			canvas = document.getElementById(oldCanvas);
			var ctx = canvas.getContext('2d');
			var oldElements = s_globalData[oldElementsName];
			var oldElement = oldElements[oldID];
			if (oldElement != null)
			{
				internalDrawFuzzyFeltElement(ctx, oldElement);
			}
		}
		if (inFuzzyID < 0)
		{
			s_globalData["mouseover.id"] = -1;
			s_globalData["mouseover.canvas"] = "";
			s_globalData["oldElementsName"] = "";
		}
	}
} 

</script>

<script type="text/javascript">

var s_globalData = new Object();

window.onload = function()
{
	fuzzyInit();
}

function fuzzyInit()
{
	s_globalData["mouseover.canvas"] = "";
	s_globalData["mouseover.id"] = -1;
	window.addEventListener('mousemove', mouseMove, true);
	window.addEventListener('mouseup', mouseUp, true);
	window.addEventListener('keydown', keyDown, true);
	window.addEventListener('keyup', keyUp, true);

	var resourceNames = [
		'P1',
		'P2',
		'P3',
		'P4',
		'P5',
		'P6',
		'P7',
		'P8',
		'P9',
		'P10',
		'P11',
		'P12',
		'P13',
		'P14',
		'P15',
		'P16',
		'P17',
		'P18',
		'P19',
		'P20',
		'P21',
	];

	var resourceTasks = [
		new TaskItem("P1", "AA: make it rock", 1, TASK_DONE),
		new TaskItem("P1", "BB: make it rain", 2, HIGH_PRIORITY),
		new TaskItem("P1", "CC: make it snow", 3, MEDIUM_PRIORITY),
		new TaskItem("P1", "DD: make it hail", 4, LOW_PRIORITY),
		new TaskItem("P1", "EE: make it shine", 5, HOLIDAY),
		new TaskItem("P1", "FF: make it so", 6, TASK_UNDEFINED),
		new TaskItem("P1", "GG: make it so so", 7, HIGH_RISK),
		new TaskItem("P2", "GG: make it rock", 7, TASK_DONE),
		new TaskItem("P2", "FF: make it rain", 6, HIGH_PRIORITY),
		new TaskItem("P2", "EE: make it snow", 5, MEDIUM_PRIORITY),
		new TaskItem("P2", "DD: make it hail", 4, LOW_PRIORITY),
		new TaskItem("P2", "CC: make it shine", 3, HOLIDAY),
		new TaskItem("P2", "BB: make it so", 2, TASK_UNDEFINED),
		new TaskItem("P2", "AA: make it so so", 1, HIGH_RISK),
	];

	const planStartDate = "31/10/2011";
	var sortedTasks = makeSortedTasks(resourceTasks, planStartDate);

	var selectedNames= [];

	s_globalData["fuzzy.resourceNames"] = resourceNames;
	s_globalData["fuzzy.resourceTasks"] = resourceTasks;
	s_globalData["fuzzy.sortedTasks"] = sortedTasks;
	s_globalData["fuzzy.fullPlanStartDate"] = planStartDate;

	drawFullView();
}

function drawFullView()
{
	resetSelections();
	doFuzzyFelts();
}

function resetSelections()
{
	s_globalData["fuzzy.selectedNames"] = [];
	s_globalData["fuzzy.drawShort"] = true;
	s_globalData["fuzzy.drawMedium"] = true;
	s_globalData["fuzzy.drawLong"] = true;
	s_globalData["fuzzy.showSelectedDates"] = false;
	s_globalData["fuzzy.selectedPlanStartDate"] = "";
	s_globalData["fuzzy.selectedPlanNumWeeks"] = 1;

	doFuzzyFelts();
}

function doFuzzyFelts()
{
	var resourceNames = s_globalData["fuzzy.resourceNames"];
	var sortedTasks = s_globalData["fuzzy.sortedTasks"];

	var selectedNames = s_globalData["fuzzy.selectedNames"];

	var names = [];
	var tasks = [];
	if (selectedNames.length > 0)
	{
		for (var s = 0; s < selectedNames.length; s++)
		{
			var selectedName = selectedNames[s];
			for (var n = 0; n < resourceNames.length; n++)
			{
				var name = resourceNames[n];
				if (name == selectedName)
				{
					//infoMessage("SelectedName: " + selectedName);
					names.push(selectedName);
				}
			}
		}
	}
	else
	{
		names = resourceNames;
	}

	tasks = sortedTasks;

	var fullPlanStartDate = s_globalData["fuzzy.fullPlanStartDate"];
	var planStartDate = fullPlanStartDate;
	var showSelectedDates = s_globalData["fuzzy.showSelectedDates"];
	if (showSelectedDates == true)
	{
		var selectedPlanStartDate = s_globalData["fuzzy.selectedPlanStartDate"];
		planStartDate = selectedPlanStartDate;
	}

	makeFuzzyFelts(planStartDate, names, tasks);
}

function makeFuzzyFelts(planStartDate, names, sortedTasks)
{
	var shortCanvas = document.getElementById("canvas_short");
	var mediumCanvas = document.getElementById("canvas_medium");
	var longCanvas = document.getElementById("canvas_long");

	const cellWidth = 250;
	const cellHeight = 120;
	const nameX = 0;
	const weekX = nameX + 120;
	const weekY = cellHeight;
	const widthExtra = 50;
	const heightExtra = 00;

	var drawShort = s_globalData["fuzzy.drawShort"];
	var drawMedium = s_globalData["fuzzy.drawMedium"];
	var drawLong = s_globalData["fuzzy.drawLong"];

	var shortElements = [];
	var mediumElements = [];
	var longElements = [];

	if (shortCanvas != null)
	{
		shortCanvas.width = 0;
		shortCanvas.height = 0;
	}
	if (mediumCanvas != null)
	{
		mediumCanvas.width = 0;
		mediumCanvas.height = 0;
	}
	if (longCanvas != null)
	{
		longCanvas.width = 0;
		longCanvas.height = 0;
	}

	var fuzzyViewData = new FuzzyViewData(cellWidth, cellHeight, nameX, weekX, weekY);

	var dateStart = planStartDate;

	var shortNumWeeks = 4;
	const shortDateStart = planStartDate;

	var showSelectedDates = s_globalData["fuzzy.showSelectedDates"];
	if (showSelectedDates == true)
	{
		shortNumWeeks = s_globalData["fuzzy.selectedPlanNumWeeks"];
	}
	if (drawShort)
	{
		numWeeks = computeNumWeeksToShow(shortDateStart, shortNumWeeks);

		width = 0;
		height = 0;
		if (numWeeks > 0)
		{
			width = fuzzyViewData.m_cellWidth * numWeeks + fuzzyViewData.m_weekX + widthExtra;
			height = (names.length+1) * fuzzyViewData.m_cellHeight + fuzzyViewData.m_weekY + heightExtra;
		}
		if (shortCanvas != null)
		{
			shortCanvas.width = width;
			shortCanvas.height = height;
		}

		shortElements = makeFuzzyFelt(shortCanvas, fuzzyViewData, names, sortedTasks, true, dateStart, numWeeks);
		//myLog("short: " + width + " x " + height);
	}

	const mediumNumWeeks = 13;
	const mediumDateStart = addDates(shortDateStart, (0+shortNumWeeks)*7);
	if (drawMedium)
	{
		fuzzyViewData.m_cellWidth = 250;

		numWeeks = computeNumWeeksToShow(mediumDateStart, mediumNumWeeks);
		dateStart = mediumDateStart;

		width = 0;
		height = 0;
		if (numWeeks > 0)
		{
			width = fuzzyViewData.m_cellWidth * numWeeks + fuzzyViewData.m_weekX + widthExtra;
			height = (names.length+1) * fuzzyViewData.m_cellHeight + fuzzyViewData.m_weekY + heightExtra;
		}
		if (mediumCanvas != null)
		{
			mediumCanvas.width = width;
			mediumCanvas.height = height;
		}
		//myLog("medium: " + width + " x " + height);

		mediumElements = makeFuzzyFelt(mediumCanvas, fuzzyViewData, names, sortedTasks, false, dateStart, numWeeks);
	}

	const longNumWeeks = 52-mediumNumWeeks-shortNumWeeks;
	const longDateStart = addDates(mediumDateStart, mediumNumWeeks*7);
	if (drawLong)
	{
		fuzzyViewData.m_cellWidth = 250;

		numWeeks = computeNumWeeksToShow(longDateStart, longNumWeeks);
		dateStart = longDateStart;

		width = 0;
		height = 0;
		if (numWeeks > 0)
		{
			width = fuzzyViewData.m_cellWidth * numWeeks + fuzzyViewData.m_weekX + widthExtra;
			height = (names.length+1) * fuzzyViewData.m_cellHeight + fuzzyViewData.m_weekY + heightExtra;
		}

		if (longCanvas != null)
		{
			longCanvas.width = width;
			longCanvas.height = height;
		}
		//myLog("long: " + width + " x " + height);

		longElements = makeFuzzyFelt(longCanvas, fuzzyViewData, names, sortedTasks, false, dateStart, numWeeks);
	}

	s_globalData["canvas_short.elements"] = shortElements;
	s_globalData["canvas_medium.elements"] = mediumElements;
	s_globalData["canvas_long.elements"] = longElements;

	render();
}

function render()
{
	var canvas_name = "";

	var drawShort = s_globalData["fuzzy.drawShort"];
	var drawMedium = s_globalData["fuzzy.drawMedium"];
	var drawLong = s_globalData["fuzzy.drawLong"];

	if (drawShort)
	{
		canvas_name = "canvas_short";
		renderView(canvas_name);
	}

	if (drawMedium)
	{
		canvas_name = "canvas_medium";
		renderView(canvas_name);
	}

	if (drawLong)
	{
		canvas_name = "canvas_long";
		renderView(canvas_name);
	}
}

function renderView(canvas_name)
{
	var elementsName = canvas_name+".elements";
	var elements = s_globalData[elementsName];

	drawFuzzyFelt(canvas_name, elements);
}


</script>
</div>
</body>
</html>

